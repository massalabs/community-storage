# Déploie le front (front/dist) sur DeWeb buildnet à chaque push sur main.
# Inspiré de https://github.com/massalabs/massa.net-v2
# Prérequis : créer le secret MASSA_DEWEB_SECRET_KEY dans GitHub (Settings > Secrets and variables > Actions)
# avec la clé secrète du wallet qui déploie (buildnet).
name: Deploy to DeWeb (buildnet)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: front

      - name: Build
        run: npm run build
        working-directory: front
        env:
          # Variables d'environnement optionnelles pour le build (ex. contrat buildnet)
          VITE_STORAGE_REGISTRY_ADDRESS: ${{ vars.VITE_STORAGE_REGISTRY_ADDRESS || '' }}

      - name: Deploy to DeWeb (buildnet)
        run: npx @massalabs/deweb-cli upload --config deweb_cli_config.buildnet.json front/dist
        env:
          SECRET_KEY: ${{ secrets.MASSA_DEWEB_SECRET_KEY }}
